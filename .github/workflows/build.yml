name: Build Zoom Attendance App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

permissions:
  contents: write
  packages: write

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install --upgrade setuptools wheel
        
        # Install packages individually with error handling
        pip install opencv-python>=4.8.0
        pip install mediapipe>=0.10.0
        pip install mss>=9.0.1
        pip install APScheduler>=3.10.4
        pip install pandas>=2.0.0
        pip install numpy>=1.24.0
        pip install Pillow>=10.0.0
        pip install PyQt5>=5.15.0
        pip install plyer>=2.1.0
        pip install psutil>=5.9.0
        pip install pyinstaller>=5.13.0
        pip install auto-py-to-exe>=2.40.0
        
    - name: Verify critical packages
      run: |
        python -c "import PyInstaller; print('PyInstaller OK')"
        python -c "import cv2; print('OpenCV OK')" 
        python -c "import PyQt5; print('PyQt5 OK')"
        python -c "import mediapipe; print('MediaPipe OK')"
        
    - name: Create assets directory
      run: mkdir -p assets
      
    - name: Build executable
      run: |
        python build.py
        
    - name: Test executable
      run: |
        if (Test-Path "dist/ZoomAttendance.exe") {
          Write-Host "âœ… ì‹¤í–‰íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤"
          Get-ChildItem dist/ -Recurse | Format-Table Name, Length
        } else {
          Write-Host "âŒ ì‹¤í–‰íŒŒì¼ ìƒì„± ì‹¤íŒ¨"
          exit 1
        }
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ZoomAttendance-Windows-${{ github.run_number }}
        path: |
          dist/
          release/
        retention-days: 30
        
    - name: Create Release
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v2.0-build${{ github.run_number }}
        name: "Zoom ì¶œì„ ìë™í™” v2.0 (ë¹Œë“œ #${{ github.run_number }})"
        body: |
          ## ğŸ“ Zoom ê°•ì˜ ì¶œì„ ìë™í™” v2.0
          
          ### ğŸ“¥ ë‹¤ìš´ë¡œë“œ
          - **ZoomAttendance.exe**: Windowsìš© ì‹¤í–‰íŒŒì¼
          - **ì „ì²´ íŒ¨í‚¤ì§€**: ì‚¬ìš© ì„¤ëª…ì„œ í¬í•¨
          
          ### ğŸ¯ ì£¼ìš” ê¸°ëŠ¥
          - ë“€ì–¼ ëª¨ë‹ˆí„° ì§€ì› (ì„œë¸Œëª¨ë‹ˆí„° ìë™ ê°ì§€)
          - ì‹¤ì‹œê°„ ì–¼êµ´ ê°ì§€ ë° ì‹œê°í™”
          - ìë™ êµì‹œ ìŠ¤ì¼€ì¤„ë§ (ì ì‹¬ì‹œê°„ ì œì™¸)
          - ì°¸ê°€ì ìˆ˜ ì‹¤ì‹œê°„ ì¹´ìš´íŒ…
          - ì•Œë¦¼ ì‹œìŠ¤í…œ
          
          ### ğŸš€ ì‚¬ìš©ë²•
          1. ZoomAttendance.exe ë‹¤ìš´ë¡œë“œ
          2. Windows ì»´í“¨í„°ì—ì„œ ë”ë¸”í´ë¦­ ì‹¤í–‰
          3. ì„œë¸Œëª¨ë‹ˆí„°ì— Zoom ì‹¤í–‰
          4. "ëª¨ë‹ˆí„°ë§ ì‹œì‘" ë²„íŠ¼ í´ë¦­
          
          ### âš ï¸ ì£¼ì˜ì‚¬í•­
          - Windows 10/11 í•„ìš”
          - ê´€ë¦¬ì ê¶Œí•œ ê¶Œì¥
          - ë°”ì´ëŸ¬ìŠ¤ ë°±ì‹  í—ˆìš© ì²˜ë¦¬ í•„ìš”í•  ìˆ˜ ìˆìŒ
          
          ---
          ë¹Œë“œ ì‹œê°„: ${{ github.event.head_commit.timestamp }}
          ì»¤ë°‹: ${{ github.sha }}
        files: |
          release/*.zip
          dist/ZoomAttendance.exe
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

